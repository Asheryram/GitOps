// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERSION 2: STRICT (FAIL-FAST)
// Any security finding at HIGH or CRITICAL severity immediately fails the build
// with error(). No catchError wrapping on scan stages â€” a failure here means
// the pipeline stops and never reaches Push â†’ Deploy â†’ Verify.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

pipeline {
    agent any

    tools {
        nodejs 'nodejs-20'
    }

    environment {
        AWS_REGION       = 'eu-central-1'
        ECR_REGISTRY     = '962496666337.dkr.ecr.eu-central-1.amazonaws.com'
        IMAGE_TAG        = "${BUILD_NUMBER}"
        ECR_REPO         = 'jenkins-cicd-pipeline-app'
        ECS_CLUSTER      = 'jenkins-cicd-pipeline-cluster'
        ECS_SERVICE      = 'jenkins-cicd-pipeline-service'
        ECS_TASK_FAMILY  = 'jenkins-cicd-pipeline-task'
    }

    stages {

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 1. CHECKOUT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                checkout scm
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 2. SECRET SCANNING â€” BLOCKS on any finding
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Secret Scanning') {
            steps {
                echo 'Scanning for secrets with Gitleaks...'
                sh '''
                    docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect \
                        --source /repo \
                        --report-path /repo/gitleaks-report.json \
                        --report-format json \
                        --no-git || true
                '''
                script {
                    checkGitleaksReport()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 3. INSTALL DEPENDENCIES
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Install Dependencies') {
            steps {
                echo 'Installing dependencies...'
                sh 'npm ci'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 4. SAST - SONARQUBE â€” BLOCKS on gate failure
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('SAST - SonarQube') {
            steps {
                echo 'Running SAST with SonarQube...'
                script {
                    runSonarQubeScan()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 5. SCA - DEPENDENCY CHECK â€” BLOCKS on HIGH+
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('SCA - Dependency Check') {
            steps {
                echo 'Running SCA with npm audit and Snyk...'
                script {
                    runNpmAudit()
                    runSnykScan()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 6. UNIT TESTS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Unit Tests') {
            steps {
                echo 'Running unit tests...'
                sh 'npm test'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 7. BUILD DOCKER IMAGE
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                sh '''
                    docker build -t $ECR_REPO:$BUILD_NUMBER .
                    docker tag $ECR_REPO:$BUILD_NUMBER $ECR_REPO:latest
                '''
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 8. GENERATE SBOM
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Generate SBOM') {
            steps {
                echo 'Generating SBOM with Syft...'
                sh '''
                    docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                        anchore/syft:latest $ECR_REPO:$BUILD_NUMBER \
                        -o cyclonedx-json > sbom-cyclonedx.json

                    docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                        anchore/syft:latest $ECR_REPO:$BUILD_NUMBER \
                        -o spdx-json > sbom-spdx.json
                '''
                archiveArtifacts artifacts: 'sbom-*.json', fingerprint: true
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 9. CONTAINER IMAGE SCAN - TRIVY â€” BLOCKS on CRITICAL/HIGH
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Container Image Scan') {
            steps {
                echo 'Scanning container image with Trivy...'
                sh '''
                    docker run --rm \
                    -v /var/run/docker.sock:/var/run/docker.sock \
                    -v $WORKSPACE:/workspace \
                    aquasec/trivy:latest \
                    image --format json \
                    --output /workspace/trivy-report.json \
                    $ECR_REPO:$BUILD_NUMBER
                '''
                script {
                    analyzeTrivyReport()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 10. QUALITY GATE â€” only reached if all scans passed
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Quality Gate Check') {
            steps {
                echo ' All security quality gates passed â€” proceeding to deployment'
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 11. PUSH TO ECR
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Push to ECR') {
            steps {
                echo 'Pushing image to Amazon ECR...'
                script {
                    pushToECR()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 12. UPDATE ECS TASK DEFINITION
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Update ECS Task Definition') {
            steps {
                echo 'Registering new ECS task definition...'
                script {
                    updateECSTaskDefinition()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 13. DEPLOY TO ECS
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Deploy to ECS') {
            steps {
                echo 'Updating ECS service with new task definition...'
                script {
                    deployToECS()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 14. VERIFY DEPLOYMENT
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Verify Deployment') {
            steps {
                echo 'Verifying deployment health...'
                script {
                    verifyDeployment()
                }
            }
        }

        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // 15. CLEANUP OLD ECR IMAGES
        // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        stage('Cleanup Old Images') {
            steps {
                echo 'Cleaning up old ECR images...'
                script {
                    cleanupOldImages()
                }
            }
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // POST ACTIONS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    post {
        always {
            echo 'Archiving security reports and artifacts...'
            archiveArtifacts artifacts: '**/*-report.json, sbom-*.json',
                            fingerprint: true,
                            allowEmptyArchive: true

            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: '.',
                reportFiles: 'trivy-report.json',
                reportName: 'Trivy Security Report'
            ])

            sh '''
                docker rmi $ECR_REPO:$BUILD_NUMBER || true
                docker rmi $ECR_REPO:latest || true
                docker rmi $ECR_REGISTRY/$ECR_REPO:$BUILD_NUMBER || true
                docker rmi $ECR_REGISTRY/$ECR_REPO:latest || true
                docker system prune -f || true
            '''

            cleanWs()
        }

        success {
            echo "Pipeline completed successfully! Build #${BUILD_NUMBER} deployed to ECS."
            script {
                def message = """
                 Deployment Successful (Strict Mode)

                Build:       #${BUILD_NUMBER}
                Image:       ${ECR_REGISTRY}/${ECR_REPO}:${IMAGE_TAG}
                ECS Cluster: ${ECS_CLUSTER}
                ECS Service: ${ECS_SERVICE}

                All security gates passed with zero HIGH/CRITICAL findings:
                   Gitleaks  (Secret Scanning)
                   SonarQube (SAST)
                   npm audit + Snyk (SCA)
                   Trivy     (Container Scan)

                Artifacts:
                  - SBOM (CycloneDX & SPDX)
                  - Security scan reports
                """
                echo message
            }
        }

        failure {
            echo ' Pipeline FAILED!'
            script {
                def failureReason = """
                DEPLOYMENT BLOCKED

                The pipeline was halted by a security gate failure or build error.
                Review the stage logs and security reports to identify the cause.

                Common causes:
                  - Secrets detected by Gitleaks
                  - SonarQube quality gate failed
                  - HIGH/CRITICAL CVEs found by npm audit or Snyk
                  - HIGH/CRITICAL CVEs found by Trivy in the container image
                """
                echo failureReason
            }
        }
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPER FUNCTIONS â€” STRICT VARIANTS
// error() immediately fails and stops the pipeline.
// returnStatus: true is used on sh() calls so we can inspect exit codes
// ourselves rather than letting a non-zero exit bubble up uncontrolled.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def checkGitleaksReport() {
    if (fileExists('gitleaks-report.json')) {
        def report = readJSON file: 'gitleaks-report.json'
        if (report && report.size() > 0) {
            error("ðŸš« BLOCKED: ${report.size()} secret(s) detected by Gitleaks. " +
                  "Fix all secrets before merging. Review gitleaks-report.json for details.")
        } else {
            echo ' No secrets detected'
        }
    } else {
        echo '  No Gitleaks report found â€” skipping secret check'
    }
}

def runSonarQubeScan() {
    withSonarQubeEnv('SonarQube') {
        sh '''
            sonar-scanner \
                -Dsonar.projectKey=cicd-node-app \
                -Dsonar.organization=asheryram \
                -Dsonar.sources=. \
                -Dsonar.exclusions=node_modules/**,test/**
        '''
    }
    timeout(time: 5, unit: 'MINUTES') {
        def qg = waitForQualityGate()
        if (qg.status != 'OK') {
            error(" BLOCKED: SonarQube quality gate failed with status: ${qg.status}. " +
                  "Fix all code quality issues before deploying.")
        }
    }
    echo ' SAST passed'
}

def runNpmAudit() {
    // Always write the full JSON report regardless of outcome
    sh 'npm audit --json > npm-audit-report.json || true'

    // Use returnStatus so we control the failure message
    def exitCode = sh(script: 'npm audit --audit-level=high', returnStatus: true)
    if (exitCode != 0) {
        error(' BLOCKED: npm audit found HIGH or CRITICAL vulnerabilities in dependencies. ' +
              'Run "npm audit fix" or update affected packages before deploying.')
    }
    echo ' npm audit passed'
}

def runSnykScan() {
    withCredentials([string(credentialsId: 'snyk-token', variable: 'SNYK_TOKEN')]) {
        // Always write the full JSON report regardless of outcome
        sh 'npx snyk test --json > snyk-report.json || true'

        // Use returnStatus so we control the failure message
        def exitCode = sh(script: 'npx snyk test --severity-threshold=high', returnStatus: true)
        if (exitCode != 0) {
            error(' BLOCKED: Snyk found HIGH or CRITICAL vulnerabilities in dependencies. ' +
                  'Review snyk-report.json and remediate all HIGH/CRITICAL issues before deploying.')
        }
    }
    echo ' Snyk scan passed'
}

def analyzeTrivyReport() {
    def trivyReport = readJSON file: 'trivy-report.json'
    def criticalCount = 0
    def highCount = 0
    def criticalVulns = []
    def highVulns = []

    trivyReport.Results?.each { result ->
        result.Vulnerabilities?.each { vuln ->
            if (vuln.Severity == 'CRITICAL') {
                criticalCount++
                criticalVulns << "${vuln.VulnerabilityID} in ${vuln.PkgName} (${vuln.InstalledVersion})"
            }
            if (vuln.Severity == 'HIGH') {
                highCount++
                highVulns << "${vuln.VulnerabilityID} in ${vuln.PkgName} (${vuln.InstalledVersion})"
            }
        }
    }

    echo "Trivy found: ${criticalCount} Critical, ${highCount} High vulnerabilities"

    if (criticalCount > 0) {
        echo "Critical CVEs found:"
        criticalVulns.take(10).each { echo "  - ${it}" }
    }
    if (highCount > 0) {
        echo "High CVEs found:"
        highVulns.take(10).each { echo "  - ${it}" }
    }

    if (criticalCount > 0 || highCount > 0) {
        error(" BLOCKED: Trivy found ${criticalCount} CRITICAL and ${highCount} HIGH vulnerabilities " +
              "in the container image. Update base image and dependencies before deploying. " +
              "Review trivy-report.json for full details.")
    }

    echo ' Container scan passed'
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SHARED DEPLOY HELPERS (identical in both versions)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def pushToECR() {
    sh '''
        echo "Logging in to ECR..."
        aws ecr get-login-password --region $AWS_REGION | \
            docker login --username AWS --password-stdin $ECR_REGISTRY

        echo "Tagging Docker image..."
        docker tag $ECR_REPO:$BUILD_NUMBER $ECR_REGISTRY/$ECR_REPO:$BUILD_NUMBER
        docker tag $ECR_REPO:$BUILD_NUMBER $ECR_REGISTRY/$ECR_REPO:latest

        echo "Pushing Docker image to ECR..."
        docker push $ECR_REGISTRY/$ECR_REPO:$BUILD_NUMBER
        docker push $ECR_REGISTRY/$ECR_REPO:latest
    '''
}

def updateECSTaskDefinition() {
    sh '''
        aws ecs describe-task-definition \
            --task-definition $ECS_TASK_FAMILY \
            --query 'taskDefinition' > current-task-def.json

        jq --arg IMAGE "$ECR_REGISTRY/$ECR_REPO:$BUILD_NUMBER" \
            '.containerDefinitions[0].image = $IMAGE |
            del(.taskDefinitionArn, .revision, .status, .requiresAttributes,
            .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' \
            current-task-def.json > new-task-def.json

        aws ecs register-task-definition \
            --cli-input-json file://new-task-def.json \
            --query 'taskDefinition.revision' \
            --output text > task-revision.txt

        echo "Registered new task definition revision: $(cat task-revision.txt)"
    '''
}

def deployToECS() {
    def taskRevision = sh(script: 'cat task-revision.txt', returnStdout: true).trim()
    sh """
        aws ecs update-service \
            --cluster ${ECS_CLUSTER} \
            --service ${ECS_SERVICE} \
            --task-definition ${ECS_TASK_FAMILY}:${taskRevision} \
            --force-new-deployment

        echo "Waiting for deployment to complete..."
        aws ecs wait services-stable \
            --cluster ${ECS_CLUSTER} \
            --services ${ECS_SERVICE}

        echo "ECS service updated successfully"
    """
}

def verifyDeployment() {
    sh '''
        SERVICE_STATUS=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].status' \
            --output text)

        RUNNING_COUNT=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].runningCount' \
            --output text)

        DESIRED_COUNT=$(aws ecs describe-services \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --query 'services[0].desiredCount' \
            --output text)

        echo "Service Status: $SERVICE_STATUS"
        echo "Running Tasks: $RUNNING_COUNT/$DESIRED_COUNT"

        if [ "$SERVICE_STATUS" = "ACTIVE" ] && [ "$RUNNING_COUNT" = "$DESIRED_COUNT" ]; then
            echo " Deployment verification successful"
        else
            echo " Deployment verification failed"
            exit 1
        fi
    '''
}

def cleanupOldImages() {
    sh '''
        OLD_IMAGES=$(aws ecr list-images \
            --repository-name $ECR_REPO \
            --filter tagStatus=TAGGED \
            --query 'imageIds[10:]' \
            --output json)

        if [ "$OLD_IMAGES" != "[]" ] && [ "$OLD_IMAGES" != "null" ]; then
            echo "Deleting old images..."
            aws ecr batch-delete-image \
                --repository-name $ECR_REPO \
                --image-ids "$OLD_IMAGES" || true
            echo "Old images cleaned up"
        else
            echo "No old images to clean up"
        fi
    '''
}
